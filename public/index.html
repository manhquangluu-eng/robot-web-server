<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫¢NG ƒêI·ªÄU KHI·ªÇN ROBOT</title>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- C·∫§U H√åNH M√ÄU S·∫ÆC --- */
      :root {
        --bg-body: #121212;
        --bg-panel: #1e1e1e;
        --bg-input: #2c2c2c;
        --text-main: #e0e0e0;
        --text-sub: #a0a0a0;
        --accent-cyan: #00ffcc;
        --accent-red: #ff4757;
        --accent-orange: #ff9f43;
        --border-color: #333;
        --radius: 12px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        font-size: 14px;
      }

      /* HEADER */
      .page-header h1 {
        color: var(--accent-cyan);
        text-align: center;
        margin: 0 0 25px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 24px;
      }

      /* --- LAYOUT L∆Ø·ªöI TH√îNG MINH (SMART GRID) --- */
      .main-grid {
        display: grid;
        /* C·ªôt tr√°i 350px, C·ªôt ph·∫£i ph·∫ßn c√≤n l·∫°i */
        grid-template-columns: 350px 1fr;
        /* D√≤ng t·ª± ƒë·ªông co gi√£n theo n·ªôi dung */
        grid-template-rows: auto auto 1fr;
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* --- ƒê·ªäNH V·ªä V·ªä TR√ç C√ÅC PANEL --- */

      /* 1. Tr·∫°ng th√°i k·∫øt n·ªëi (C·ªôt 1, D√≤ng 1) */
      .area-status {
        grid-column: 1;
        grid-row: 1;
      }

      /* 2. Gi√°m s√°t t·ª± h√†nh (C·ªôt 1, D√≤ng 2) */
      .area-auto {
        grid-column: 1;
        grid-row: 2;
      }

      /* 3. ƒêi·ªÅu khi·ªÉn th·ªß c√¥ng (C·ªôt 1, D√≤ng 3) */
      .area-manual {
        grid-column: 1;
        grid-row: 3;
        height: 100%;
      }

      /* 4. BI·ªÇU ƒê·ªí (C·ªôt 2, CHI·∫æM D√íNG 1 V√Ä 2) -> Gi·∫£i quy·∫øt y√™u c·∫ßu 1 */
      .area-chart {
        grid-column: 2;
        grid-row: 1 / span 2; /* Chi·∫øm t·ª´ d√≤ng 1 v√† k√©o d√†i 2 d√≤ng */
        height: 100%; /* K√©o gi√£n chi·ªÅu cao cho b·∫±ng c·ªôt tr√°i */
        display: flex;
        flex-direction: column;
      }

      /* 5. L·ªäCH S·ª¨ (C·ªôt 2, D√≤ng 3) -> Gi·∫£i quy·∫øt y√™u c·∫ßu 2 (N·∫±m ngang h√†ng Manual) */
      .area-history {
        grid-column: 2;
        grid-row: 3;
        height: 100%; /* K√©o gi√£n chi·ªÅu cao b·∫±ng v·ªõi Manual b√™n c·∫°nh */
        display: flex;
        flex-direction: column;
      }

      /* Responsive Mobile: Chuy·ªÉn v·ªÅ 1 c·ªôt d·ªçc */
      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
        }
        .area-status,
        .area-auto,
        .area-manual,
        .area-chart,
        .area-history {
          grid-column: auto;
          grid-row: auto;
        }
      }

      /* --- STYLE PANEL --- */
      .panel {
        background: var(--bg-panel);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      .panel-header {
        color: var(--text-sub);
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      /* CSS C√ÅC TH√ÄNH PH·∫¶N CON (Gi·ªØ nguy√™n style ƒë·∫πp c≈©) */
      .status-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-input);
        padding: 12px 15px;
        border-radius: 8px;
      }
      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        color: #7f8c8d;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #7f8c8d;
      }
      .status-online {
        color: var(--accent-cyan);
      }
      .status-online .dot {
        background: var(--accent-cyan);
        box-shadow: 0 0 8px var(--accent-cyan);
      }

      .auto-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #444;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--accent-cyan);
      }
      input:checked + .slider:before {
        transform: translateX(24px);
      }

      .action-display {
        background: #252525;
        color: var(--accent-orange);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        border: 1px dashed #444;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .metric-item {
        background: var(--bg-input);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .metric-val {
        font-size: 20px;
        font-weight: bold;
        color: var(--accent-cyan);
        margin: 0;
      }
      .metric-val.speed {
        color: var(--accent-orange);
      }

      .d-pad-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
      }
      .btn-ctrl {
        background: var(--bg-input);
        border: none;
        color: white;
        border-radius: 8px;
        height: 50px;
        font-size: 18px;
        cursor: pointer;
        transition: 0.1s;
        box-shadow: 0 3px 0 #111;
      }
      .btn-ctrl:active {
        transform: translateY(3px);
        box-shadow: none;
        background: var(--accent-cyan);
        color: #000;
      }
      .btn-stop {
        background: var(--accent-red);
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 3px 0 #c0392b;
      }
      .btn-stop:active {
        background: #ff1f33;
      }
      .rotation-row {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .rotation-row .btn-ctrl {
        flex: 1;
        font-size: 14px;
      }
      .speed-slider-container input[type="range"] {
        width: 100%;
        height: 6px;
        background: #444;
        border-radius: 5px;
        outline: none;
        -webkit-appearance: none;
      }
      .speed-slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-cyan);
        cursor: pointer;
        border: 3px solid #222;
      }

      /* BI·ªÇU ƒê·ªí FULL CHI·ªÄU CAO */
      .chart-container {
        flex: 1;
        position: relative;
        min-height: 300px;
        width: 100%;
      }

      /* L·ªäCH S·ª¨ FULL CHI·ªÄU CAO */
      .history-filter {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .input-dark {
        background: var(--bg-input);
        border: 1px solid #444;
        color: white;
        padding: 8px;
        border-radius: 6px;
        outline: none;
        width: 100%;
      }
      .btn-view {
        background: var(--accent-cyan);
        color: #000;
        border: none;
        font-weight: bold;
        padding: 9px 20px;
        border-radius: 6px;
        cursor: pointer;
        height: 35px;
      }
      .table-wrapper {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #333;
        border-radius: 8px;
        min-height: 200px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th {
        background: #252525;
        color: var(--text-sub);
        padding: 10px;
        text-align: left;
        position: sticky;
        top: 0;
      }
      td {
        padding: 10px;
        border-bottom: 1px solid #333;
        color: var(--text-main);
      }
      tr:hover {
        background: #2c2c2c;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #1e1e1e;
      }
      ::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="page-header">
      <h1><i class="fas fa-robot"></i> B·∫¢NG ƒêI·ªÄU KHI·ªÇN ROBOT</h1>
    </div>

    <div class="main-grid">
      <div class="panel area-status">
        <div class="status-box">
          <span class="status-label"
            ><i class="fas fa-wifi"></i> TR·∫†NG TH√ÅI:</span
          >
          <div id="connectionStatus" class="status-indicator">
            <div class="dot"></div>
            <span id="statusText">M·∫§T K·∫æT N·ªêI</span>
          </div>
        </div>
      </div>

      <div class="panel area-auto">
        <div class="panel-header">
          <i class="fas fa-eye"></i> Gi√°m S√°t & T·ª± H√†nh
        </div>
        <div class="auto-controls">
          <span>CH·∫æ ƒê·ªò T·ª∞ L√ÅI:</span>
          <label class="toggle-switch">
            <input
              type="checkbox"
              id="autoModeToggle"
              onchange="toggleAutoMode(this)"
            />
            <span class="slider"></span>
          </label>
        </div>
        <div id="robotAction" class="action-display">ƒêang ch·ªù l·ªánh...</div>
        <div class="metrics-grid">
          <div class="metric-item">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px">
              KHO·∫¢NG C√ÅCH
            </div>
            <p class="metric-val" id="distVal">--</p>
          </div>
          <div class="metric-item">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px">
              T·ªêC ƒê·ªò
            </div>
            <p class="metric-val speed" id="speedVal">--</p>
          </div>
        </div>
      </div>

      <div class="panel area-chart">
        <div class="panel-header">
          <i class="fas fa-chart-line"></i> Bi·ªÉu ƒê·ªì Ho·∫°t ƒê·ªông (Live)
        </div>
        <div class="chart-container">
          <canvas id="robotChart"></canvas>
        </div>
      </div>

      <div class="panel area-manual">
        <div class="panel-header">
          <i class="fas fa-gamepad"></i> ƒêi·ªÅu Khi·ªÉn Th·ªß C√¥ng
        </div>
        <div class="d-pad-grid">
          <button
            class="btn-ctrl"
            onmousedown="send('K')"
            onmouseup="send('S')"
            ontouchstart="send('K')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-up" style="transform: rotate(-45deg)"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('F')"
            onmouseup="send('S')"
            ontouchstart="send('F')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-up"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('Q')"
            onmouseup="send('S')"
            ontouchstart="send('Q')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-up" style="transform: rotate(45deg)"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('G')"
            onmouseup="send('S')"
            ontouchstart="send('G')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-left"></i>
          </button>
          <button
            class="btn-ctrl btn-stop"
            onmousedown="send('S')"
            ontouchstart="send('S')"
          >
            STOP
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('I')"
            onmouseup="send('S')"
            ontouchstart="send('I')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-right"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('H')"
            onmouseup="send('S')"
            ontouchstart="send('H')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-down" style="transform: rotate(45deg)"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('B')"
            onmouseup="send('S')"
            ontouchstart="send('B')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-down"></i>
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('J')"
            onmouseup="send('S')"
            ontouchstart="send('J')"
            ontouchend="send('S')"
          >
            <i class="fas fa-arrow-down" style="transform: rotate(-45deg)"></i>
          </button>
        </div>
        <div class="rotation-row">
          <button
            class="btn-ctrl"
            onmousedown="send('L')"
            onmouseup="send('S')"
            ontouchstart="send('L')"
            ontouchend="send('S')"
          >
            <i class="fas fa-undo"></i> Quay Tr√°i
          </button>
          <button
            class="btn-ctrl"
            onmousedown="send('R')"
            onmouseup="send('S')"
            ontouchstart="send('R')"
            ontouchend="send('S')"
          >
            Quay Ph·∫£i <i class="fas fa-redo"></i>
          </button>
        </div>
        <div class="speed-slider-container">
          <input
            type="range"
            min="60"
            max="255"
            value="150"
            oninput="sendSpeed(this.value)"
          />
        </div>
      </div>

      <div class="panel area-history">
        <div class="panel-header">
          <i class="fas fa-history"></i> B√°o C√°o L·ªãch S·ª≠ Di Chuy·ªÉn
        </div>
        <div class="history-filter">
          <div class="input-group">
            <label>T·ª´ th·ªùi ƒëi·ªÉm:</label>
            <input type="datetime-local" id="startTime" class="input-dark" />
          </div>
          <div class="input-group">
            <label>ƒê·∫øn th·ªùi ƒëi·ªÉm:</label>
            <input type="datetime-local" id="endTime" class="input-dark" />
          </div>
          <button class="btn-view" onclick="loadHistory()">Xem B√°o C√°o</button>
        </div>
        <div class="table-wrapper">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>Kho·∫£ng c√°ch</th>
                <th>T·ªëc ƒë·ªô</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td
                  colspan="4"
                  align="center"
                  style="color: #666; padding: 20px"
                >
                  Ch·ªçn th·ªùi gian ƒë·ªÉ xem
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let lastHeartbeat = 0;

      function setOnlineStatus(isOnline) {
        const statusBox = document.getElementById("connectionStatus");
        const statusText = document.getElementById("statusText");
        if (isOnline) {
          statusBox.classList.add("status-online");
          statusText.innerText = "ƒê√É K·∫æT N·ªêI";
        } else {
          statusBox.classList.remove("status-online");
          statusText.innerText = "M·∫§T K·∫æT N·ªêI";
        }
      }
      setInterval(() => {
        if (Date.now() - lastHeartbeat > 5000) setOnlineStatus(false);
      }, 2000);

      socket.on("sensor_update", (data) => {
        lastHeartbeat = Date.now();
        setOnlineStatus(true);
        document.getElementById("distVal").innerText = data.khoang_cach;
        document.getElementById("speedVal").innerText = data.toc_do;
        if (data.hanh_dong) {
          const actionBox = document.getElementById("robotAction");
          actionBox.innerText = data.hanh_dong;
          actionBox.style.color = data.khoang_cach < 20 ? "#ff4757" : "#00ffcc";
        }
        updateChart(data.khoang_cach, data.toc_do);
      });

      function send(cmd) {
        socket.emit("control_cmd", cmd);
      }
      function sendSpeed(val) {
        socket.emit("speed_cmd", val);
      }

      function toggleAutoMode(checkbox) {
        const actionBox = document.getElementById("robotAction");
        if (checkbox.checked) {
          socket.emit("control_cmd", "A");
          actionBox.innerText = "üîÑ ƒêANG CH·∫†Y T·ª∞ ƒê·ªòNG...";
          actionBox.style.color = "#ff9f43";
        } else {
          socket.emit("control_cmd", "M");
          actionBox.innerText = "üéÆ CH·∫æ ƒê·ªò TH·ª¶ C√îNG";
          actionBox.style.color = "#a0a0a0";
          send("S");
        }
      }

      const ctx = document.getElementById("robotChart").getContext("2d");
      Chart.defaults.color = "#7f8c8d";
      Chart.defaults.borderColor = "#333";
      const robotChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Kho·∫£ng c√°ch",
              borderColor: "#00ffcc",
              backgroundColor: "rgba(0, 255, 204, 0.1)",
              data: [],
              tension: 0.4,
              fill: true,
              pointRadius: 0,
            },
            {
              label: "T·ªëc ƒë·ªô",
              borderColor: "#ff9f43",
              backgroundColor: "transparent",
              data: [],
              tension: 0.4,
              borderDash: [5, 5],
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { beginAtZero: true, grid: { color: "#333" } },
          },
        },
      });

      function updateChart(dist, speed) {
        const now = new Date().toLocaleTimeString();
        robotChart.data.labels.push(now);
        robotChart.data.datasets[0].data.push(dist);
        robotChart.data.datasets[1].data.push(speed);
        if (robotChart.data.labels.length > 30) {
          robotChart.data.labels.shift();
          robotChart.data.datasets[0].data.shift();
          robotChart.data.datasets[1].data.shift();
        }
        robotChart.update();
      }

      window.onload = function () {
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const nowStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
          now.getDate()
        )}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
        const startStr = `${oneHourAgo.getFullYear()}-${pad(
          oneHourAgo.getMonth() + 1
        )}-${pad(oneHourAgo.getDate())}T${pad(oneHourAgo.getHours())}:${pad(
          oneHourAgo.getMinutes()
        )}`;
        document.getElementById("endTime").value = nowStr;
        document.getElementById("startTime").value = startStr;
      };

      function loadHistory() {
        const startVal = document.getElementById("startTime").value;
        const endVal = document.getElementById("endTime").value;

        // 2. Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ch·ªçn gi·ªù ch∆∞a
        if (!startVal || !endVal) {
          alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
          return;
        }

        // 3. Hi·ªÉn th·ªã th√¥ng b√°o "ƒêang t·∫£i..." l√™n b·∫£ng
        const tbody = document
          .getElementById("historyTable")
          .querySelector("tbody");
        tbody.innerHTML =
          '<tr><td colspan="4" align="center" style="padding:20px; color: #00ffcc;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Cloud... <i class="fas fa-spinner fa-spin"></i></td></tr>';

        // 4. --- B∆Ø·ªöC QUAN TR·ªåNG: CHUY·ªÇN ƒê·ªîI SANG UTC ---
        // MongoDB l∆∞u gi·ªù UTC (GMT+0), n√™n ta c·∫ßn ƒë·ªïi gi·ªù VN (GMT+7) sang UTC tr∆∞·ªõc khi g·ª≠i
        const startDate = new Date(startVal).toISOString();
        const endDate = new Date(endVal).toISOString();

        // Debug: In ra Console ƒë·ªÉ ki·ªÉm tra (F12)
        console.log(`T√¨m ki·∫øm (Local - VN): ${startVal} -> ${endVal}`);
        console.log(`T√¨m ki·∫øm (Server - UTC): ${startDate} -> ${endDate}`);

        // 5. G·ª≠i y√™u c·∫ßu l√™n Server
        socket.emit("get_history", { startTime: startDate, endTime: endDate });
      }

      socket.on("history_data_result", (historyArray) => {
        const tbody = document
          .getElementById("historyTable")
          .querySelector("tbody");
        tbody.innerHTML = "";
        if (!historyArray || historyArray.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" align="center">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
          return;
        }
        historyArray.forEach((item) => {
          const row = document.createElement("tr");
          let timeStr = item.timestamp
            ? new Date(item.timestamp).toLocaleString("vi-VN")
            : "N/A";
          let statusHint = "B√¨nh th∆∞·ªùng";
          if (item.khoang_cach < 20) statusHint = "‚ö†Ô∏è G·∫ßn v·∫≠t c·∫£n";
          if (item.toc_do == 0) statusHint = "ƒêang d·ª´ng";
          row.innerHTML = `<td style="color:#00ffcc">${timeStr}</td><td><b>${item.khoang_cach}</b></td><td>${item.toc_do}</td><td style="color:#aaa">${statusHint}</td>`;
          tbody.appendChild(row);
        });
      });

      document.querySelectorAll(".btn-ctrl").forEach((btn) => {
        btn.addEventListener("touchstart", (e) => e.preventDefault(), {
          passive: false,
        });
      });
    </script>
  </body>
</html>
