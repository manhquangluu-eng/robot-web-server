<!DOCTYPE html>
<html>
  <head>
    <title>Robot Cloud Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* --- C·∫§U H√åNH C∆† B·∫¢N --- */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        background: #1a1a1a;
        color: #ecf0f1;
        margin: 0;
        padding-bottom: 50px;
      }
      h1 {
        color: #00ffcc;
        margin-top: 20px;
        text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      }

      /* --- DASHBOARD TH·∫∫ S·ªê --- */
      .dashboard {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px;
        flex-wrap: wrap;
      }
      .card {
        background: #2d2d2d;
        padding: 20px;
        border-radius: 15px;
        min-width: 140px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
      }
      .card h3 {
        margin: 0;
        color: #aaa;
        font-size: 14px;
      }
      .card h2 {
        margin: 10px 0 0;
        font-size: 36px;
      }

      /* --- B·∫¢NG ƒêI·ªÄU KHI·ªÇN (GRID) --- */
      .btn-grid {
        display: grid;
        grid-template-columns: repeat(3, 70px);
        gap: 15px;
        justify-content: center;
        margin: 30px auto;
      }

      /* --- N√öT B·∫§M (C√ì HI·ªÜU ·ª®NG) --- */
      button {
        width: 70px;
        height: 70px;
        font-size: 28px;
        cursor: pointer;
        border-radius: 12px;
        border: none;
        background: #444;
        color: white;
        box-shadow: 0 4px 0 #222; /* T·∫°o ƒë·ªô n·ªïi 3D */
        transition: all 0.1s; /* Hi·ªáu ·ª©ng m∆∞·ª£t */
        user-select: none; /* Ch·ªëng b√¥i ƒëen khi nh·∫•n gi·ªØ */
      }

      /* Hi·ªáu ·ª©ng khi nh·∫•n gi·ªØ (Active) */
      button:active {
        background-color: #00ffcc; /* ƒê·ªïi m√†u s√°ng khi nh·∫•n */
        color: #000;
        box-shadow: 0 0 0 #222; /* M·∫•t ƒë·ªô n·ªïi */
        transform: translateY(4px); /* N√∫t l√∫n xu·ªëng */
      }

      /* N√∫t Stop ri√™ng bi·ªát */
      .stop {
        background: #e74c3c;
        box-shadow: 0 4px 0 #c0392b;
      }
      .stop:active {
        background: #ff0000;
        box-shadow: 0 0 0 #c0392b;
      }

      /* --- SLIDER T·ªêC ƒê·ªò --- */
      input[type="range"] {
        width: 80%;
        max-width: 300px;
        margin: 20px 0;
        accent-color: #00ffcc;
      }

      /* --- BI·ªÇU ƒê·ªí (CHART) --- */
      .chart-container {
        width: 90%;
        max-width: 600px;
        margin: 30px auto;
        background: #2d2d2d;
        padding: 15px;
        border-radius: 15px;
        border: 1px solid #444;
      }
    </style>
  </head>
  <body>
    <h1>üõ∏ CLOUD CONTROL CENTER</h1>

    <div class="dashboard">
      <div class="card">
        <h3>KHO·∫¢NG C√ÅCH</h3>
        <h2 id="distVal" style="color: #00ffcc">--</h2>
        <small>cm</small>
      </div>
      <div class="card">
        <h3>T·ªêC ƒê·ªò</h3>
        <h2 id="speedVal" style="color: #ff9f43">--</h2>
        <small>PWM</small>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="robotChart"></canvas>
    </div>

    <div class="btn-grid">
      <button
        onmousedown="send('K')"
        onmouseup="send('S')"
        ontouchstart="send('K')"
        ontouchend="send('S')"
      >
        ‚Üñ
      </button>
      <button
        onmousedown="send('F')"
        onmouseup="send('S')"
        ontouchstart="send('F')"
        ontouchend="send('S')"
      >
        ‚Üë
      </button>
      <button
        onmousedown="send('Q')"
        onmouseup="send('S')"
        ontouchstart="send('Q')"
        ontouchend="send('S')"
      >
        ‚Üó
      </button>

      <button
        onmousedown="send('L')"
        onmouseup="send('S')"
        ontouchstart="send('L')"
        ontouchend="send('S')"
      >
        ‚Ü∫
      </button>
      <button class="stop" onmousedown="send('S')">S</button>
      <button
        onmousedown="send('R')"
        onmouseup="send('S')"
        ontouchstart="send('R')"
        ontouchend="send('S')"
      >
        ‚Üª
      </button>

      <button
        onmousedown="send('H')"
        onmouseup="send('S')"
        ontouchstart="send('H')"
        ontouchend="send('S')"
      >
        ‚Üô
      </button>
      <button
        onmousedown="send('B')"
        onmouseup="send('S')"
        ontouchstart="send('B')"
        ontouchend="send('S')"
      >
        ‚Üì
      </button>
      <button
        onmousedown="send('J')"
        onmouseup="send('S')"
        ontouchstart="send('J')"
        ontouchend="send('S')"
      >
        ‚Üò
      </button>
    </div>

    <label>ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô c∆° b·∫£n:</label><br />
    <input
      type="range"
      min="60"
      max="255"
      value="150"
      onchange="sendSpeed(this.value)"
    />

    <script>
      const socket = io();

      // --- 1. C·∫§U H√åNH BI·ªÇU ƒê·ªí (CHART.JS) ---
      const ctx = document.getElementById("robotChart").getContext("2d");
      const robotChart = new Chart(ctx, {
        type: "line", // D·∫°ng bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
        data: {
          labels: [], // Nh√£n th·ªùi gian (tr·ª•c ngang)
          datasets: [
            {
              label: "Kho·∫£ng c√°ch (cm)",
              borderColor: "#00ffcc",
              backgroundColor: "rgba(0, 255, 204, 0.2)",
              data: [],
              tension: 0.4, // L√†m m·ªÅm ƒë∆∞·ªùng cong
              fill: true,
            },
            {
              label: "T·ªëc ƒë·ªô (PWM)",
              borderColor: "#ff9f43",
              backgroundColor: "rgba(255, 159, 67, 0.0)",
              data: [],
              tension: 0.4,
              borderDash: [5, 5], // ƒê∆∞·ªùng n√©t ƒë·ª©t cho t·ªëc ƒë·ªô
            },
          ],
        },
        options: {
          responsive: true,
          interaction: {
            mode: "index",
            intersect: false, // R√™ chu·ªôt v√†o l√† th·∫•y th√¥ng s·ªë
          },
          scales: {
            x: { ticks: { color: "#aaa" } },
            y: { ticks: { color: "#aaa" }, beginAtZero: true },
          },
          plugins: {
            legend: { labels: { color: "#fff" } },
          },
        },
      });

      // --- 2. NH·∫¨N D·ªÆ LI·ªÜU T·ª™ SERVER ---
      socket.on("sensor_update", (data) => {
        // C·∫≠p nh·∫≠t s·ªë hi·ªÉn th·ªã
        document.getElementById("distVal").innerText = data.khoang_cach;
        document.getElementById("speedVal").innerText = data.toc_do;

        // C·∫≠p nh·∫≠t Bi·ªÉu ƒë·ªì
        updateChart(data.khoang_cach, data.toc_do);
      });

      // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì (Gi·ªØ l·∫°i 20 ƒëi·ªÉm d·ªØ li·ªáu m·ªõi nh·∫•t)
      function updateChart(dist, speed) {
        const now = new Date().toLocaleTimeString(); // L·∫•y gi·ªù hi·ªán t·∫°i

        // Th√™m d·ªØ li·ªáu m·ªõi
        robotChart.data.labels.push(now);
        robotChart.data.datasets[0].data.push(dist);
        robotChart.data.datasets[1].data.push(speed);

        // X√≥a d·ªØ li·ªáu c≈© n·∫øu qu√° d√†i (ƒë·ªÉ bi·ªÉu ƒë·ªì ch·∫°y m∆∞·ª£t)
        if (robotChart.data.labels.length > 20) {
          robotChart.data.labels.shift();
          robotChart.data.datasets[0].data.shift();
          robotChart.data.datasets[1].data.shift();
        }

        robotChart.update(); // V·∫Ω l·∫°i
      }

      // --- 3. G·ª¨I L·ªÜNH ---
      function send(cmd) {
        socket.emit("control_cmd", cmd);
      }
      function sendSpeed(val) {
        socket.emit("speed_cmd", val);
      }

      // H·ªó tr·ª£ c·∫£m ·ª©ng ƒëi·ªán tho·∫°i t·ªët h∆°n (ngƒÉn k√©o trang khi b·∫•m n√∫t)
      document.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("touchstart", (e) => {
          e.preventDefault();
        });
      });
    </script>
  </body>
</html>
